name: Varredura de Segurança (SAST e DAST)

on:
  push:
    branches: [ "main", "master" ] # Rodar no push para o branch principal
  pull_request:
    branches: [ "main", "master" ] # Rodar em PRs para o branch principal
  workflow_dispatch: # Permite rodar manualmente

jobs:
  #-----------------------------------------
  # NÓ DE SAST (Análise Estática)
  #-----------------------------------------
  sast_codeql:
    name: SAST (CodeQL)
    runs-on: ubuntu-latest
    
    permissions:
      security-events: write # Necessário para o CodeQL enviar alertas para a aba "Security"
      actions: read
      contents: read

    steps:
      - name: Checkout do repositório
        uses: actions/checkout@v4

      # Inicializa o scanner CodeQL
      - name: Inicializar CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python # <-- Mude aqui se for outra linguagem

      # Compila/Instala dependências (se necessário)
      # O CodeQL tentará autodetectar, mas para Python é bom ter o setup
      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10' # Ajuste a versão do Python

      - name: Instalar dependências
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      # Executa a análise do CodeQL
      - name: Performar Análise CodeQL
        uses: github/codeql-action/analyze@v3

  #-----------------------------------------
  # NÓ DE DAST (Análise Dinâmica)
  #-----------------------------------------
  dast_zap:
    name: DAST (OWASP ZAP)
    runs-on: ubuntu-latest
    
    # O DAST precisa que o SAST passe primeiro (opcional, mas recomendado)
    needs: sast_codeql

    steps:
      - name: Checkout do repositório
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10' # Ajuste a versão

      - name: Instalar dependências
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      # Inicia a aplicação em background
      # IMPORTANTE: Ajuste este comando para como seu app inicia
      - name: Iniciar Aplicação (ex: Streamlit)
        run: |
          streamlit run app.py &
          sleep 15 # Dá 15 segundos para o servidor iniciar

      # Executa o ZAP Baseline Scan
      - name: ZAP Baseline Scan
        uses: ZAP/action-baseline@v0.11.0
        with:
          # URL alvo. Ajuste a porta se for diferente (Streamlit usa 8501)
          target: 'http://localhost:8501'
          
          # Validação: Falha a build se encontrar alertas (padrão é 'true')
          # fail_action: true 
          
          # Gera um relatório HTML
          cmd_options: '-r zap_report.html'

      # Upload do relatório DAST (sempre, mesmo se falhar)
      - name: Upload Relatório DAST
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-report
          path: zap_report.html
