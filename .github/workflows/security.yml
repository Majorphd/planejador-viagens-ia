name: Varredura de Segurança (SAST e DAST)

on:
  push:
    branches: [ "main" ] # Assumindo que seu branch principal é 'main'
  pull_request:
    branches: [ "main" ]
  workflow_dispatch: # Permite rodar manualmente

jobs:
  #-----------------------------------------
  # NÓ 1: SAST (Análise Estática)
  #-----------------------------------------
  sast_codeql:
    name: SAST (CodeQL)
    runs-on: ubuntu-latest
    
    permissions:
      security-events: write # Necessário para o CodeQL enviar alertas
      actions: read
      contents: read

    steps:
      - name: Checkout do repositório
        uses: actions/checkout@v4

      # Inicializa o scanner CodeQL para Python
      - name: Inicializar CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python

      # Configura o ambiente Python para o CodeQL analisar
      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10' # Pode ajustar se usar outra

      - name: Instalar dependências
        run: |
          pip install -r requirements.txt
          
      # VALIDAÇÃO (SAST): O CodeQL analisa e falha se encontrar erros graves
      - name: Performar Análise CodeQL
        uses: github/codeql-action/analyze@v3

  #-----------------------------------------
  # NÓ 2: DAST (Análise Dinâmica)
  #-----------------------------------------
  dast_zap:
    name: DAST (OWASP ZAP)
    runs-on: ubuntu-latest
    
    # Espera o SAST terminar com sucesso
    needs: sast_codeql 

    steps:
      - name: Checkout do repositório
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Instalar dependências
        run: |
          pip install -r requirements.txt

      # Inicia o app Streamlit em background (porta padrão 8501)
      - name: Iniciar Aplicação Streamlit
        run: |
          streamlit run app.py &
          sleep 15 # Dá 15 segundos para o servidor iniciar

      # Executa o ZAP Baseline Scan
      - name: ZAP Baseline Scan
        uses: ZAP/action-baseline@v0.11.0
        with:
          # URL alvo (Streamlit roda na 8501 por padrão)
          target: 'http://localhost:8501'
          
          # VALIDAÇÃO (DAST): 'fail_action: true' é o padrão.
          # Isso significa que o job FALHARÁ se o ZAP encontrar
          # qualquer alerta (WARN ou FAIL), validando o pipeline.
          
          # Gera um relatório HTML para análise
          cmd_options: '-r zap_report.html'

      # Upload do relatório DAST (sempre, mesmo se falhar)
      - name: Upload Relatório DAST
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-report
          path: zap_report.html
